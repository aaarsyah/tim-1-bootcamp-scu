@page "/confirm-email"

@using System.ComponentModel.DataAnnotations
@using MudBlazor.Services;
@using Microsoft.Extensions.Localization;
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation
@inject ISnackbar Snackbar

@inject IAuthService AuthService

<PageTitle>Confirm Email Success</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center mt-8">
    <MudImage Src="img/animasiconfirmsuccess.svg" Alt="Email Confirmation Animation" Width="250" Height="250"/>
    <MudText Class="mb-2" Typo="Typo.h2" Align="Align.Center" Style="font-weight: 500">Konfirmasi Email Berhasil</MudText>
    <MudText Class="mb-4" Typo="Typo.body1" Align="Align.Center">Silahkan Login terlebih dahulu untuk masuk ke aplikasi</MudText>
    <MudButton OnClick="Navigation.GoToLogin" Variant="Variant.Filled" Color="Color.Primary" Style="width: 176px; height: 55px; border-radius: 6px">
        <MudText Typo="Typo.h4" Style="font-weight: 600; font-size: 15px">Masuk Sekarang</MudText>
    </MudButton>
</MudContainer>

@code {

    private ConfirmEmailRequestDto _confirmEmailModel { get; set; } = new();

    [SupplyParameterFromQuery(Name = "email")]
    private string? Email { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    private string? Token { get; set; }
    //Cek apakah token verifikasi email valid ketika user meng-load page ini
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _confirmEmailModel ??= new ConfirmEmailRequestDto();

        // Validasi apakah ada email dan taken
        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            // Langsung redirect ke home bila email atau token tidak ada
            Navigation.GoToHome();
            return;
        }

        // Set email dan token dari query parameters
        _confirmEmailModel.Email = Uri.UnescapeDataString(Email ?? string.Empty);
        _confirmEmailModel.AccessToken = Uri.UnescapeDataString(Token ?? string.Empty);


        try
        {
            // Debug: Check if model has values
            Console.WriteLine($"DEBUG - Email: '{_confirmEmailModel.Email}', Token: '{_confirmEmailModel.AccessToken}'");

            if (string.IsNullOrEmpty(_confirmEmailModel.Email) ||
                string.IsNullOrEmpty(_confirmEmailModel.AccessToken))
            {
                Snackbar.Add("Email confirmation token invalid.", Severity.Warning);
                return;
            }

            var result = await AuthService.ConfirmEmailAsync(_confirmEmailModel);

            if (result)
            {
                Snackbar.Add("Email successfully confirmed!", Severity.Success);

                // Wait 2 seconds then redirect to login
                await Task.Delay(2000);
                Navigation.GoToHome();
            }
            else
            {
                Snackbar.Add("Failed to confirm email. Email confirmation token may be invalid.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            Console.WriteLine($"ERROR: {ex}");
        }
        await base.OnInitializedAsync();
    }
}