@page "/login"
@using System.ComponentModel.DataAnnotations
@using MudBlazor.Services
@using Microsoft.Extensions.Localization
@using MyApp.BlazorUI.Components
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation
@inject ISnackbar Snackbar

@inject IAuthService AuthService

<PageTitle>Login</PageTitle>

<MudPaper Class="pa-0 mx-auto mt-12" MaxWidth="800px" Elevation="0">
    <MudText Class="mb-4" Typo="Typo.h2" Style="font-weight: 400">Selamat Datang Musikers!</MudText>
    <MudText Class="mb-4" Typo="Typo.body1">Login dulu yuk</MudText>
    
    <MudForm @ref="_form">
        <MudTextField @bind-Value="_loginModel.Email"
                      Label="Email"
                      Variant="Variant.Outlined"
                      Required="true"
                      RequiredError="Email Harus diisi!"
                      Validation="@(new EmailAddressAttribute() { ErrorMessage = "Format Email salah" })" />
        <MudTextField @bind-Value="_loginModel.Password"
                      Label="Password"
                      Variant="Variant.Outlined"
                      InputType="@_passwordInputType"
                      Required="true"
                      RequiredError="Password Harus Diisi!"
                      MaxLength="72"
                      Adornment="Adornment.End"
                      AdornmentIcon="@_passwordIcon"
                      OnAdornmentClick="TogglePasswordVisibility"
                      Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" />

        <MudCheckBox @bind-Value="_loginModel.RememberMe" Label="Remember Me" Color="Color.Primary" Class="mb-4" />          

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <!-- Forgot password link -->
        <div class="d-flex justify-end mb-4">
            <MudText Typo="Typo.body2">
                <MudLink OnClick="Navigation.GoToForgotPass" Color="Color.Primary">Lupa kata sandi</MudLink>
            </MudText>
        </div>

        <!-- Login button -->
        <MudButton OnClick="OnConfirm" Variant="Variant.Filled" Color="Color.Primary" Style="width: 140px; height: 43px; border-radius: 8px">
            <MudText Typo="Typo.h4" Style="font-weight: 500; font-size: 15px">Masuk</MudText>
        </MudButton>

        <!-- Register link -->
        <div class="mt-2">
            <MudText Typo="Typo.body1">
                Belum punya akun? 
                <MudLink OnClick="Navigation.GoToRegister" Color="Color.Primary" Class="ml-1">Daftar disini</MudLink>
            </MudText>
        </div>
    </MudForm>
</MudPaper>

@code {
    private MudForm _form;
    private LoginRequestDto _loginModel { get; set; } = new();

    private bool _isLoading = false;
    private string _errorMessage = string.Empty;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password Harus Diisi!";
            yield break;
        } //ditambahkan validasi password salah (sesuai database)
    }

    private void TogglePasswordVisibility()
    {
        if (_passwordInputType == InputType.Password)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private async Task OnConfirm()
    {
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            if (string.IsNullOrEmpty(_loginModel.Email) || string.IsNullOrEmpty(_loginModel.Password))
            {
                _errorMessage = "Please fill in all fields";
                Snackbar.Add("Please fill in all fields", Severity.Warning);
                return;
            }

            var result = await AuthService.LoginAsync(_loginModel);

            if (result != null)
            {
                Snackbar.Add("Login successful!", Severity.Success);
                if (result.User != null && result.User.Roles.Contains("Admin"))
                {
                    Navigation.GoToDashboard();
                }
                else
                {
                    Navigation.GoToHome2(); //Login balik ke home page //harusnya masuk ke landing page
                }

            }
            else
            {
                _errorMessage = "Invalid email or password";
                Snackbar.Add("Login failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred during login";
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            Console.WriteLine($"ERROR: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }
}
