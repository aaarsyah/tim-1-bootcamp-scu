@page "/profil"
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@using MyApp.BlazorUI.Services


<PageTitle>Profil Saya</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-10">
    <MudPaper Class="pa-6 rounded-lg elevation-4">
        <MudStack Spacing="4" AlignItems="AlignItems.Center">

            <MudAvatar Size="Size.Large" Alt="Profile Photo" Src="img/profile-placeholder.png" />

            <MudText Typo="Typo.h5" Align="Align.Center"><b>@UserName</b></MudText>
            <MudText Typo="Typo.body2" Align="Align.Center">@UserEmail</MudText>

            <MudDivider />

            <MudStack Direction="Row" Justify="Justify.Center" Spacing="2" Class="mt-4">
                
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Logout">
                    Logout
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private string UserName = "Loading...";
    private string UserEmail = "Loading...";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCurrentUserAsync();
        }
    }

    private async Task LoadCurrentUserAsync()
    {
        var token = await AuthService.GetAccessTokenAsync();
        if (token != null)
        {
            var user = await AuthService.GetCurrentUserAsync(token);
            if (user != null)
            {
                UserName = user.Name;
                UserEmail = user.Email;
                StateHasChanged();
            }
            else
            {
                UserName = "Unknown";
                UserEmail = "Unknown";
            }
        }
    }

    private void EditProfile()
    {
        NavigationManager.NavigateTo("/edit-profil");
    }

    private async Task Logout()
    {
        var token = await AuthService.GetAccessTokenAsync();
        if (token != null)
        {
            await AuthService.LogoutAsync(token);
        }
        NavigationManager.NavigateTo("/login");
    }
}
