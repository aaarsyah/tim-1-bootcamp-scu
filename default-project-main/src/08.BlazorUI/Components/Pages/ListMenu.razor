@page "/listmenu/{CategoryId:int}"

@using System.Globalization
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs


@inject NavigationManagerExt Navigation

@inject ICourseService CourseService

<PageTitle>Daftar Kelas</PageTitle>

<div class="pa-0 ma-n4">
    <MudImage Class="" Src="@CategoryImage" Alt="Category Banner" Style="width: 100%; height: 334px;"></MudImage>
</div> 
<br />

<MudContainer>
    @if (CategoryName != null)
    {
        <MudText Class="mt-8" Typo="Typo.h2">@CategoryName</MudText>
        <MudText Class="mt-8">@CategoryDescription</MudText>
    }
    else if (IsCategoryLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    
    <MudText Class="mt-16" Typo="Typo.h2" Align="Align.Center" Style="font-family: Inter" Color="Color.Primary">
        Kelas yang tersedia
    </MudText>

    <MudGrid Class="mb-20 mt-4 gap-10 gap-x-20 d-flex justify-start">
        @if (Courses != null)
        {
            @foreach (var course in Courses)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudLink OnClick="@(() => Navigation.GoToDetail(course.Id))" Color="Color.Default">
                        <MudImage Src="@(!string.IsNullOrEmpty(course.ImageUrl) ? course.ImageUrl : "img/default-course.svg")" Class="w-100 mb-2" />
                        <MudText Typo="Typo.h4" Style="font-weight: 400; color: #828282">@course.CategoryName</MudText>
                        <MudText Typo="Typo.h3">@course.Name</MudText>
                        <MudText Class="pt-10" Typo="Typo.h3" Color="Color.Primary">IDR @course.Price.ToString("N0", new CultureInfo("id-ID"))</MudText>
                    </MudLink>
                </MudItem>
            }
        }
        else if (IsCourseLoading)
        {
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <MudText>Tidak ada kelas tersedia.</MudText>
        }
    </MudGrid>
</MudContainer>

@code {
    [Parameter]
    public int CategoryId { get; set; }

    private string? CategoryName;
    private string? CategoryDescription;
    private string? CategoryImage;

    private List<CourseDto>? Courses;

    private bool IsCategoryLoading = true;
    private bool IsCourseLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Fetch Category by Id
        var result = await CourseService.GetCategoryByIdAsync(CategoryId);
        if (result != null)
        {
            CategoryName = result.Name;
            CategoryDescription = result.Description;
            CategoryImage = !string.IsNullOrEmpty(result.ImageUrl)
                ? result.ImageUrl
                : "img/Class1.svg";
        }

        // Fetch all courses
        var result2 = await CourseService.GetCourseByCategoryAsync(CategoryId);
        if (result2 != null)
        {
            Courses = result2
                .Where(c => c.IsActive && c.CategoryId == CategoryId) // filter by category
                .ToList();
        }
        IsCourseLoading = false;
    }
}
