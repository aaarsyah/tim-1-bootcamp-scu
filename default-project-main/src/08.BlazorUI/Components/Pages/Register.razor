@page "/register"
@using System.Text.RegularExpressions;
@using System.ComponentModel.DataAnnotations;
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation;
@inject ISnackbar Snackbar

@inject IAuthService AuthService

<PageTitle>Register</PageTitle>

<MudPaper Class="pa-0 mx-auto mt-12" MaxWidth="800px" Elevation="0">
    <MudForm @ref="_form">
    <MudText Typo="Typo.h5" Class="mb-4">Selamat Datang Musikers!</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4">Yuk daftar terlebih dahulu akun kamu</MudText>
        <MudTextField T="string"
                      Label="Nama Lengkap"
                      Variant="Variant.Outlined"
                      @bind-Value="_registerModel.Name"
                      Required="true"
                      RequiredError="Nama Lengkap Harus Diisi!"
                      MaxLength="64" />
        <MudTextField T="string" 
                      Label="Email"
                      Variant="Variant.Outlined"
                      @bind-Value="_registerModel.Email"
                      Required="true"
                      RequiredError="Email Harus diisi!"
                      MaxLength="256"
                      Validation="@(new EmailAddressAttribute() {ErrorMessage = "Format Email Salah"})" />
        <MudTextField T="string"
                      Label="Password"
                      Variant="Variant.Outlined"
                      @bind-Value="_registerModel.NewPassword"
                      @ref="pwField1"
                      InputType="@_newPasswordInputType"
                      Required="true"
                      RequiredError="Password Harus Diisi!"
                      MaxLength="100"
                      Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))"
                      Adornment="Adornment.End"
                      AdornmentIcon="@_newPasswordIcon"
                      OnAdornmentClick="ToggleNewPasswordVisibility"
                      HelperText="Min 8 characters, uppercase, lowercase, number, special char" />
        <MudTextField T="string"
                      Label="Konfirmasi Password"
                      Variant="Variant.Outlined"
                      @bind-Value="_registerModel.ConfirmNewPassword"
                      InputType="@_confirmPasswordInputType"
                      Required="true"
                      RequiredError="Konfirmasi Password Harus Diisi!"
                      MaxLength="100"
                      Validation="@(new Func<string, string>(PasswordMatch))"
                      Adornment="Adornment.End"
                      AdornmentIcon="@_confirmPasswordIcon"
                      OnAdornmentClick="ToggleConfirmPasswordVisibility"
                      HelperText="Repeat the password" />

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">@_successMessage</MudAlert>
        }

        <!-- Register button -->
        <MudStack Direction="Row" Spacing="5" Row="true">
        <MudButton OnClick="OnConfirm" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Style="width: 140px; height: 43px; border-radius: 8px">
            Daftar
        </MudButton>
                    
        <!-- Login Link -->
        <div Class="d-flex align-center mt-4">
            <MudText Typo="Typo.body2" Class="d-flex align-center">
                Sudah punya akun? 
                <MudLink OnClick="Navigation.GoToLogin" Color="Color.Primary" Class="ml-1" >Login disini</MudLink>
            </MudText>
        </div>
        </MudStack>
    </MudForm>   
</MudPaper>


@code {
    private MudTextField<string> pwField1;
    private MudForm _form;

    private bool _isLoading = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    private InputType _newPasswordInputType = InputType.Password;
    private string _newPasswordIcon = Icons.Material.Filled.VisibilityOff;
    private InputType _confirmPasswordInputType = InputType.Password;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    private RegisterRequestDto _registerModel = new();

    private void ToggleNewPasswordVisibility()
    {
        if (_newPasswordInputType == InputType.Password)
        {
            _newPasswordInputType = InputType.Text;
            _newPasswordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _newPasswordInputType = InputType.Password;
            _newPasswordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private void ToggleConfirmPasswordVisibility()
    {
        if (_confirmPasswordInputType == InputType.Password)
        {
            _confirmPasswordInputType = InputType.Text;
            _confirmPasswordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _confirmPasswordInputType = InputType.Password;
            _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password Harus Diisi!";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Password must be at least of length 8";
        if (!Regex.IsMatch(pw, @"[A-Z]"))
            yield return "Password must contain at least one capital letter";
        if (!Regex.IsMatch(pw, @"[a-z]"))
            yield return "Password must contain at least one lowercase letter";
        if (!Regex.IsMatch(pw, @"\d"))
            yield return "Password must contain at least one digit number";
        if (!Regex.IsMatch(pw, @"[ -/:-@[-`{-~]"))
            yield return "Password must contain at least one special character";
    }

    private string PasswordMatch(string arg)
    {
        if (pwField1.Value != arg)
            return "Password tidak sesuai";
        return string.Empty;
    }

    private async Task OnConfirm()
    {
        // REGISTER
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }
        _isLoading = true;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            var result = await AuthService.RegisterAsync(_registerModel);

            if (result)
            {
                _successMessage = "Registration successful! Please check your email to confirm your account.";
                Snackbar.Add("Registration successful!", Severity.Success);

                // Redirect to login after 2 seconds
                await Task.Delay(5000);
                Navigation.GoToHome();
            }
            else
            {
                _errorMessage = "Registration failed. Please check your information and try again.";
                Snackbar.Add("Registration failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred during registration";
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}