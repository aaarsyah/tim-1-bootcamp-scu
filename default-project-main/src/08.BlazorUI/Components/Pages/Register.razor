@page "/register"
@using System.Text.RegularExpressions;
@using System.ComponentModel.DataAnnotations;
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs
@inject IAuthService AuthService
@inject NavigationManagerExt Navigation;
@inject ISnackbar Snackbar


<PageTitle>Register</PageTitle>

        <MudPaper Class="pa-0 mx-auto mt-12" MaxWidth="800px" Elevation="0">
        <MudForm @ref="_form">
        <MudText Typo="Typo.h5" Class="mb-4">Selamat Datang Musikers!</MudText>
        <MudText Typo="Typo.subtitle1" Class="mb-4">Yuk daftar terlebih dahulu akun kamu</MudText>

                    <MudTextField T="string"
                      Label="Masukkan Nama Lengkap"
                      Variant="Variant.Outlined"
                      @bind-Value="_registerModel.Name"
                      Required="true"
                      RequiredError="Nama Lengkap Harus Diisi!" />


                    <MudTextField T="string" 
                        Label="Masukkan Email" 
                        Variant="Variant.Outlined"
                        @bind-Value="_registerModel.Email"
                        Required="true" 
                        RequiredError="Email Harus diisi!"
                        Validation="@(new EmailAddressAttribute() {ErrorMessage = "Format Email Salah '@' dan '.'"})" />

    
                    <MudTextField T="string" 
                        Label="Masukkan Password" 
                        @bind-Value="_registerModel.Password"
                        HelperText="Choose a strong password" 
                        Variant="Variant.Outlined"
                        @ref="pwField1"
                        InputType="InputType.Password"
                        Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" 
                        Required="true"
                        RequiredError="Password Harus Diisi!"/>


                    <MudTextField T="string"
                            Label="Konfirmasi Password" 
                            Variant="Variant.Outlined"
                            @bind-Value="_registerModel.ConfirmPassword"
                            HelperText="Repeat the password" 
                            InputType="InputType.Password"
                            Validation="@(new Func<string, string>(PasswordMatch))"/>

                    @if (_isLoading)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    }

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
                    }

                    @if (!string.IsNullOrEmpty(_successMessage))
                    {
                        <MudAlert Severity="Severity.Success" Class="mb-4">@_successMessage</MudAlert>
                    }

                    <!-- Register button -->
                    <MudStack Direction="Row" Spacing="5" Row="true">
                    <MudButton OnClick="OnConfirm" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Style="width: 140px; height: 43px; border-radius: 8px">
                        Daftar
                    </MudButton>
                    
                    <!-- Login Link -->
                    <div Class="d-flex align-center mt-4">
                        <MudText Typo="Typo.body2" Class="d-flex align-center">
                            Sudah punya akun? 
                            <MudLink OnClick="Navigation.GoToLogin" Color="Color.Primary" Class="ml-1" >Login disini</MudLink>
                        </MudText>
                    </div>
                    </MudStack>
            </MudForm>   
        </MudPaper>


@code {
    MudTextField<string> pwField1;
    MudForm _form;

    private bool _isLoading = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    private RegisterRequestDto _registerModel = new();

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password Harus Diisi!";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Password must be at least of length 8";
        if (!Regex.IsMatch(pw, @"[A-Z]"))
            yield return "Password must contain at least one capital letter";
        if (!Regex.IsMatch(pw, @"[a-z]"))
            yield return "Password must contain at least one lowercase letter";
        if (!Regex.IsMatch(pw, @"[0-9]"))
            yield return "Password must contain at least one digit";
    }

    private string PasswordMatch(string arg)
    {
        if (pwField1.Value != arg)
            return "Password tidak sesuai";
        return string.Empty;
    }

    private async Task OnConfirm()
    {
        // REGISTER
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }
        _isLoading = true;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            var result = await AuthService.RegisterAsync(_registerModel);

            if (result != null)
            {
                _successMessage = "Registration successful! Please check your email to confirm your account.";
                Snackbar.Add("Registration successful!", Severity.Success);

                // Redirect to login after 2 seconds
                await Task.Delay(2000);
                Navigation.GoToEmailConfirmSuccess();
            }
            else
            {
                _errorMessage = "Registration failed. Please check your information and try again.";
                Snackbar.Add("Registration failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred during registration";
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}

