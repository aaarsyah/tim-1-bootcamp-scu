@page "/forgot-password"

@using System.ComponentModel.DataAnnotations
@using MudBlazor.Services;
@using Microsoft.Extensions.Localization;
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation;

@inject IAuthService AuthService

<PageTitle>Forgot Password</PageTitle>

<MudPaper Class="pa-0 mx-auto mt-12" MaxWidth="800px" Elevation="0">
    <MudText Class="mb-4" Typo="Typo.h2" Style="font-weight: 400">Reset Password</MudText>
    <MudText Class="mb-4" Typo="Typo.body1">Silahkan masukkan terlebih dahulu email Anda</MudText>

    <MudForm @ref="_form">
        <MudTextField T="string"
                      Label="Email"
                      Variant="Variant.Outlined"
                      @bind-Value="_forgotPasswordModel.Email"
                      Required="true"
                      RequiredError="Email Harus diisi!"
                      MaxLength="256"
                      Validation="@(new EmailAddressAttribute() {ErrorMessage = "Format Email Salah"})" />
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">@_successMessage</MudAlert>
        }
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }
        
        <MudStack Direction="Row" Spacing="5" Row="true" class="mt-4">
            @* Button Batal *@
            <MudButton OnClick="Navigation.GoToLogin" Variant="Variant.Outlined" Color="Color.Primary" Disabled="@(_isLoading || !string.IsNullOrEmpty(_successMessage))" Style="width: 140px; height: 43px; border-radius: 8px">
                <MudText Typo="Typo.h4" Style="font-weight: 500; font-size: 15px">Batal</MudText>
            </MudButton>
   
            @* Button Konfirmasi *@
            <MudButton OnClick="OnConfirm" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(_isLoading || !string.IsNullOrEmpty(_successMessage))" Style="width: 140px; height: 43px; border-radius: 8px">
                <MudText Typo="Typo.h4" Style="font-weight: 500; font-size: 15px">Konfirmasi</MudText>
            </MudButton>
        </MudStack>
    </MudForm>
</MudPaper>

@code {
    private MudForm _form;
    private ForgotPasswordRequestDto _forgotPasswordModel = new();

    private bool _isLoading = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    private async Task OnConfirm()
    {
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }
        _isLoading = true;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        try
        {
            var result = await AuthService.ForgotPasswordAsync(_forgotPasswordModel);
            _isLoading = false;
            if (result)
            {
                _successMessage = "Password reset link sent to email. Please check your email to reset your password. Redirecting in 5 seconds....";
                StateHasChanged();
                // Wait 5 seconds then redirect to login
                await Task.Delay(5000);
                Navigation.GoToHome();
            }
            else
            {
                _errorMessage = "impossible";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _isLoading = false;
            _errorMessage = "An error occurred during password reset";
            StateHasChanged();
        }
    }
}
