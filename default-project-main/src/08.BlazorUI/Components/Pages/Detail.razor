@page "/detail/{CourseId:int}"

@using System.Globalization
@using MyApp.Shared.DTOs
@using MyApp.BlazorUI.Services
@using System.Net.Http.Json

@inject NavigationManagerExt Navigation
@inject ISnackbar Snackbar

@inject IAuthService AuthService
@inject ICourseService CourseService
@inject ICheckoutService CheckoutService

<PageTitle>Detail Kelas</PageTitle>

<MudContainer Class="mt-10">
    @if (Course is null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">
            <MudStack Row="true">
                <MudImage Src="@Course.ImageUrl" />
                <MudContainer>
                    <MudText>@Course.CategoryName</MudText>
                    <MudText Typo="Typo.h5"><b>@Course.Name</b></MudText>
                    <MudText Typo="Typo.h5" Color="Color.Primary"><b>@($"IDR {Course.Price:N0}")</b></MudText>

                    <MudSelect Class="mt-2" @bind-Value="_date"
                               Label="Tanggal Kursus"
                               FitContent="true">
                        @foreach (var d in ScheduleDates)
                        {
                            <MudSelectItem Value="d">@d.ToString("d MMMM yyyy", new CultureInfo("id-ID"))</MudSelectItem>
                        }
                    </MudSelect>

                    <MudButton Class="px-4 mt-8" Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddToCartAsync">
                        <MudText>Masukkan Keranjang</MudText>
                    </MudButton>
                    <MudButton Class="px-4 mt-8" Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowPaymentDialog">
                        <MudText>Beli Sekarang</MudText>
                    </MudButton>
                </MudContainer>
            </MudStack>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.Xs" Invert="true">
            <MudStack>
                <MudImage Src="@Course.ImageUrl"></MudImage>
                <MudContainer>
                    <MudText>@Course.CategoryName</MudText>
                    <MudText Typo="Typo.h5"><b>@Course.Name</b></MudText>
                    <MudText Typo="Typo.h5" Color="Color.Primary"><b>@($"IDR {Course.Price:N0}")</b></MudText>

                    <MudSelect Class="mt-2" @bind-Value="_date"
                               Label="Tanggal Kursus"
                               FitContent="true">
                        @foreach (var d in ScheduleDates)
                        {
                            <MudSelectItem Value="d">@d.ToString("d MMMM yyyy", new CultureInfo("id-ID"))</MudSelectItem>
                        }
                    </MudSelect>

                    <MudButton Class="px-4 mt-8" Variant="Variant.Outlined" Color="Color.Primary" OnClick="Navigation.GoToCheckout">
                        <MudText>Masukkan Keranjang</MudText>
                    </MudButton>
                    <MudButton Class="px-4 mt-8" Variant="Variant.Filled" Color="Color.Primary" OnClick="Navigation.GoToCheckout">
                        <MudText>Beli Sekarang</MudText>
                    </MudButton>
                </MudContainer>
            </MudStack>
        </MudHidden>

        <MudText Class="mt-8" Typo="Typo.h5">
            <b>Deskripsi</b>
        </MudText>
        <MudText Class="desc mt-8">
            @Course.Description
        </MudText>

        <MudContainer>
            <MudText Class="subtitle mt-16" Typo="Typo.h5" Align="Align.Center" Color="Color.Primary">
                <b>Kelas lain yang mungkin kamu suka</b>
            </MudText>
            <MudGrid Class="mt-8">
                @if (OtherCourses != null)
                {
                    @foreach (var c in OtherCourses)
                    {
                        <MudItem xs="12" md="6" lg="4">
                            <MudLink Color="Color.Default" OnClick="@(() => Navigation.GoToDetail(c.Id))">
                                <MudImage Src="@c.ImageUrl"></MudImage>
                                <MudText>@c.CategoryName</MudText>
                                <MudText><b>@c.Name</b></MudText>
                                <MudText Color="Color.Primary"><b>@($"IDR {c.Price:N0}")</b></MudText>
                            </MudLink>
                        </MudItem>
                    }
                }
            </MudGrid>
        </MudContainer>
    }
</MudContainer>

<!-- Dialog Metode Pembayaran -->
<MudMessageBox @ref="_mudMessageBox" Title="Pilih Metode Pembayaran">
    <MessageContent>
        <MudStack>
            @if (payments.Count == 0)
            {
                <MudText>Memuat metode pembayaran...</MudText>
            }
            else
            {
                @foreach (var payment in payments)
                {
                    <MudButton 
                        Variant="@GetVariant(payment.Name)"
                        Color="@GetColor(payment.Name)"
                        OnClick="@(() => SelectPayment(payment))"
                        Style="justify-content:flex-start; width:100%; text-transform:none; margin:8px 0; border-radius:10px;">
                        
                        <MudImage Src="@payment.LogoUrl" Style="width:40px; margin-right:8px;" />
                        <MudText>@payment.Name</MudText>
                    </MudButton>
                }
            }
        </MudStack>
    </MessageContent>

    <NoButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;" OnClick="CancelPayment">
            Batal
        </MudButton>
    </NoButton>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;" OnClick="OnPaymentConfirmed">
            Bayar
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    [Parameter]
    public int CourseId { get; set; }

    private CourseDto? Course { get; set; }
    private List<CourseDto>? OtherCourses { get; set; }
    private DateOnly _date;
    private DateOnly[] ScheduleDates = Array.Empty<DateOnly>();
    private int? selectedPaymentId; //sama dengan selectedPayment

    private List<PaymentDto> payments = new();
    private PaymentDto? selectedPayment;
    private MudMessageBox _mudMessageBox;


    protected override async Task OnInitializedAsync()
    {
        await LoadPaymentsAsync();
        // Ambil data course by id
        var result = await CourseService.GetCourseByIdAsync(CourseId);
        if (result != null)
        {
            Course = result;

            ScheduleDates = Course.ScheduleDates.ToArray();

            if (ScheduleDates.Length > 0)
                _date = ScheduleDates[0];
        }
        // Ambil courses lain untuk rekomendasi
        var result2 = await CourseService.GetAllCourseAsync();
        if (result2 != null)
        {
            OtherCourses = result2
                .Where(c => c.Id != CourseId && c.IsActive)
                .ToList();
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }
        // var auth = await AuthService.GetAccessTokenAsync();
        // if (auth == null)
        // {
        //     Navigation.GoToLogin(); // User belum login, arahkan user ke login page
        //     return;
        // }
        // await LoadPaymentsAsync(auth);
        StateHasChanged();
    }

    private async Task LoadPaymentsAsync()
    {
        try
        {
            var result = await CheckoutService.GetAllPaymentsAsync();
            if (result != null)
            {
                payments = result.Where(p => p.IsActive).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat metode pembayaran: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowPaymentDialog()
    {
        await _mudMessageBox.ShowAsync();
    }

    private void SelectPayment(PaymentDto payment)
    {
        selectedPayment = payment;
        selectedPaymentId = payment.Id;
        StateHasChanged();
    }

    private Color GetColor(string name) => selectedPayment?.Name == name ? Color.Primary : Color.Default;
    private Variant GetVariant(string name) => selectedPayment?.Name == name ? Variant.Outlined : Variant.Text;

    //Cancel
    private void CancelPayment() => _mudMessageBox.Close();

    //Konfirmasi Pembayaran (Button Bayar Sekarang)
    private async Task OnPaymentConfirmed()
    {
        // Dapatkan autentikasi
        var auth = await AuthService.GetAccessTokenAsync();
        if (auth == null)
        {
            Navigation.GoToLogin(); // User belum login, arahkan user ke login page
            return;
        }
        if (selectedPaymentId == null)
        {
            Snackbar.Add("Silakan pilih metode pembayaran dulu!", Severity.Warning);
            return;
        }
        try
        {
            // 1️⃣ Ambil scheduleId berdasarkan tanggal yang dipilih
            var selectedSchedule = Course.Schedules.FirstOrDefault(s => s.Date == _date);
            if (selectedSchedule == null)
            {
                Snackbar.Add("Jadwal tidak ditemukan untuk tanggal yang dipilih.", Severity.Warning);
                return;
            }

            var scheduleId = selectedSchedule.Id;
            Console.WriteLine($"ScheduleId yang dikirim: {scheduleId}");


            // 2️⃣ Tambahkan item ke cart
            var result = await CheckoutService.AddCourseToCartAsync(auth, scheduleId);
            if (!result)
            {
                Snackbar.Add($"Gagal menambahkan ke keranjang", Severity.Error);
                return;
            }
            var result2 = await CheckoutService.GetOwnCartItem(auth);
            if (result2 == null)
            {
                Snackbar.Add("Gagal menambahkan ke keranjang?", Severity.Error);
                return;
            }
            var cartItems = result2;

            // Ambil item terbaru untuk scheduleId ini
            var lastCartItem = cartItems.OrderByDescending(c => c.Id).First();
            Console.WriteLine($"CartItem terakhir Id: {lastCartItem.Id}");


            var checkoutRequest = new CheckoutRequestDto
            {
                ItemCartIds = new List<int> { lastCartItem.Id }, 
                PaymentMethodId = selectedPaymentId.Value
            };

            // Checkout
            var result3 = await CheckoutService.CheckoutItemsAsync(auth, checkoutRequest);
            if (result3 == null)
            {
                Snackbar.Add($"Checkout gagal.", Severity.Error);
            }
            Snackbar.Add("Checkout berhasil! Mengarahkan ke halaman pembayaran...", Severity.Success);
            Navigation.GoToSuccessPurchase();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Terjadi kesalahan: {ex.Message}", Severity.Error);
        }
    }

    //Masukkan ke Keranjang
    private async Task AddToCartAsync()
    {
        // Dapatkan autentikasi
        var auth = await AuthService.GetAccessTokenAsync();
        if (auth == null)
        {
            Navigation.GoToLogin(); // User belum login, arahkan user ke login page
            return;
        }
        try
        {
            if (Course == null)
                return;

            // Ambil scheduleId dari tanggal yang dipilih (_date)
            var selectedSchedule = Course.Schedules
                .FirstOrDefault(s => s.Date == _date);

            if (selectedSchedule == null)
            {
                Console.WriteLine("Schedule not found for selected date.");
                return;
            }

            var scheduleId = selectedSchedule.Id; 

            // Panggil endpoint backend
            var result = await CheckoutService.AddCourseToCartAsync(auth, scheduleId);
            if (!result)
            {
                Snackbar.Add($"Gagal menambahkan ke keranjang", Severity.Error);
            }
            // Arahkan ke halaman checkout
            Navigation.GoToCheckout();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding to cart: {ex.Message}");
        }
    }
}