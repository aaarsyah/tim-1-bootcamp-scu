@page "/"
@using MudBlazor
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation

@inject ICourseService CourseService

<PageTitle>Home Apple Music</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0 ma-0" Style="position: relative; object-fit: cover;">
    <!-- Banner -->
    <div class="pa-0 ma-n4">
        <MudImage Class="object-cover" Src="img/LandingBanner.svg" Alt="Landing Page Banner"
                Style="display: block; width: 100%; object-fit: cover;" />
    </div>

    <!-- Overlay Content -->
    <MudContainer Class="overlay-text"
                  Style="position: absolute; 
                         overflow: scroll; 
                         inset: 0;
                         width: 100%;
                         place-items: center;
                         color: white;">
        <MudStack Spacing="2" Align="Center">                 
        <MudText Class="pt-8" Typo="Typo.h4" Align="Align.Center">
            Hi Musiker! Gabung yuk di Apel Music
        </MudText>
        <MudText Typo="Typo.h6" Class="mt-2 mb-6" Align="Align.Center">
            Banyak kelas keren yang bisa menunjang bakat bermusik kamu
        </MudText>
        </MudStack>

        <!-- Statistik -->
        <MudGrid Class="d-flex justify-space-evenly">
            <MudItem xs="12" sm="6" md="4" >
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h3" Color="Color.Primary" Align="Align.Center">
                        <b>500+</b>
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mt-4" Align="Align.Center">
                        Lebih dari sekedar kelas biasa yang bisa mengeluarkan bakat kalian
                    </MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h3" Color="Color.Primary" Align="Align.Center">
                        <b>50+</b>
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mt-4" Align="Align.Center">
                        Lulusan yang menjadi musisi ternama dengan skill memukau
                    </MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h3" Color="Color.Primary" Align="Align.Center">
                        <b>10+</b>
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mt-4" Align="Align.Center">
                        Coach Special kolaborasi dengan 
                        <br /> musisi terkenal
                    </MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudContainer>

<!-- ====== Explore Kelas Favorit ====== -->
<MudContainer MaxWidth="MaxWidth.Large" Class="py-5">
    <MudStack Spacing="4">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="subtitle mt-16 font-semibold text-balance" Color="Color.Primary">
            <b>Explore kelas favorit</b>
        </MudText>

        <MudGrid Class="mb-20 mt-4 gap-10 d-flex justify-space-evenly">
            @if (FeaturedCourses is null)
            {
                //Jika null maka akan menampilkan loading indicator
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                @foreach (var course in FeaturedCourses)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Class="course-card" Elevation="0">
                            <MudLink OnClick="@(() => Navigation.GoToDetail(course.Id.Value))" Color="Color.Default">
                                <MudImage Src="@course.Image"
                                        Class="w-100 mb-2"
                                        Alt="@course.Title" />
                                <MudText Class="category color-gray-3">@course.Category</MudText>
                                <MudText Class="name color-gray-1"><b>@course.Title</b></MudText>
                                <MudText Class="name color-iris pt-10" Color="Color.Primary">
                                    <b>@course.Price</b>
                                </MudText>
                            </MudLink>
                        </MudPaper>
                    </MudItem>
                }
            }
        </MudGrid>

            <!-- Pagination Button -->
            @if (CurrentPage < TotalPages)
            {
                <MudGrid Justify="Justify.Center" Class="mb-5">
                    <MudButton Variant="Variant.Filled"
                            Color="Color.Primary"
                            Disabled="@isLoadingMore"
                            OnClick="LoadMoreAsync">
                        @(isLoadingMore ? "Loading..." : "Load More")
                    </MudButton>
                </MudGrid>
            }
    </MudStack>
</MudContainer>


<!-- ====== Pilih Kelas Impian Kamu ====== -->
<div class="pa-0 ma-n4">
    <MudContainer MaxWidth="MaxWidth.False" Style="background-color: rgb(165 166 246 / 20%);" Class="category-section py-8" DisableGutters="true">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h5" Align="Align.Center" Class="subtitle mt-16 font-semibold text-balance" Color="Color.Primary">
                <b>Pilih kelas impian kamu</b>
            </MudText>

            <MudGrid Spacing="3" Class="mt-4 mb-20">
                @if (Categories is null)
                {
                    //Jika null maka akan menampilkan loading indicator
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                }
                else
                {
                    @foreach (var category in Categories)
                    {
                        <MudItem xs="3" sm="3" md="3" lg="3" Class="d-flex justify-space-evenly">
                            <MudLink OnClick="@(() => Navigation.GoToListMenu(category.Id.Value))" Color="Color.Default">
                                <MudImage Class="w-100 mb-2"
                                          Src="@category.Image"
                                          Alt="@category.Name" />
                                <MudText Align="Align.Center" Typo="Typo.body2"><b>@category.Name</b></MudText>
                            </MudLink>    
                        </MudItem>
                    }
                }
            </MudGrid>
        </MudStack>
    </MudContainer>
</div>

<!-- Benefit -->
 <MudContainer MaxWidth="MaxWidth.Large" Class="py-16">
            <MudGrid AlignItems="Center">
                <MudItem xs="12" md="5">
                    <div class="benefit-illustration">
                        <MudImage Src="img/LandingBenefit.svg"
                                  Alt="Guitar Player Illustration"/>
                    </div>
                </MudItem>
                <MudItem xs="12" md="7">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h5" Class="subtitle mt-16 font-semibold text-balance" Color="Color.Primary">
                        <b>Benefit ikut Apel Course</b>
                        </MudText>
                        <br/>
                        <MudText Class="category color-gray-1">
                            Dengan mengikuti AppleMusic Course, peserta akan mendapatkan berbagai keuntungan, antara lain:  
                            <ul>
                                <li>Akses ke materi musik interaktif dari instruktur profesional.</li>
                                <li>Belajar berbagai instrumen dan teknik vokal secara fleksibel kapan saja dan di mana saja.</li>
                                <li>Peningkatan kemampuan musik secara bertahap dengan modul terstruktur dan latihan praktik.</li>
                                <li>Kesempatan mengikuti workshop, performance online, dan mendapatkan sertifikat resmi.</li>
                                <li>Komunitas belajar yang mendukung, tempat berdiskusi dan berbagi pengalaman musik.</li>
                            </ul>
                        </MudText>
                        </MudStack>
                </MudItem>
            </MudGrid>
        </MudContainer>

@code {
    private record CourseCard(string Category, string Title, string Price, string Image, int? Id = null);
    private record CategoryItem(string Name, string Image, int? Id = null);

    private IEnumerable<CourseCard>? FeaturedCourses;
    private IEnumerable<CategoryItem>? Categories;
    private int CurrentPage = 1;
    private int ItemsPerPage = 6;
    private int TotalPages = 1;
    private bool isLoadingMore = false;

    // Load pertama kali
    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
        await LoadCoursesAsync();
    }

    // Load courses per halaman
    private async Task LoadCoursesAsync(int page = 1)
    {
        try
        {
            // Ambil courses
            var result = await CourseService.GetAllCoursePaginatedAsync(page, ItemsPerPage);
            if (result != null)
            {
                var courseCards = result.Data.Where(c => c.IsActive).Select(MapCourse);
                if (page == 1)
                {
                    FeaturedCourses = courseCards;
                }
                else
                {
                    FeaturedCourses = (FeaturedCourses ?? Enumerable.Empty<CourseCard>())
                        .Concat(courseCards)
                        .ToList();
                }
                CurrentPage = result.PageNumber;
                TotalPages = result.TotalPages;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading paginated courses: {ex.Message}");
        }

    }

    // Tombol Load More
    private async Task LoadMoreAsync()
    {
        if (CurrentPage < TotalPages && !isLoadingMore)
        {
            isLoadingMore = true;
            await LoadCoursesAsync(CurrentPage + 1);
            isLoadingMore = false;
            StateHasChanged();
        }
    }

    // Load Categories
    private async Task LoadCategoriesAsync()
    {
        try
        {
            // Ambil categories
            var result = await CourseService.GetAllCategoriesAsync();
            if (result != null)
            {
                Categories = result
                    .Where(c => c.IsActive)
                    .Select(c => new CategoryItem(
                        Name: c.Name,
                        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-category.svg" : c.ImageUrl,
                        Id: c.Id
                    ));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    // Mapper helper
    private CourseCard MapCourse(CourseDto c) => new(
        Category: c.CategoryName,
        Title: c.Name,
        Price: $"IDR {c.Price:N0}",
        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-course.svg" : c.ImageUrl,
        Id: c.Id
    );
}

@* @code {
    private record CourseCard(string Category, string Title, string Price, string Image, int? Id = null); // Tambahkan Id untuk navigasi
    private record CategoryItem(string Name, string Image, int? Id = null); // Tambahkan Id untuk navigasi

    private IEnumerable<CourseCard>? FeaturedCourses;
    private IEnumerable<CategoryItem>? Categories;
    private int CurrentPage = 1;
    private int ItemsPerPage = 6;
    private int TotalPages = 1;

    private async Task LoadCoursesAsync(int page = 1)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<PagedResponse<IEnumerable<CourseDto>>>(
                $"api/Course/paginated?pageNumber={page}&pageSize={ItemsPerPage}");

            if (response?.Data != null)
            {
                FeaturedCourses = response.Data.Select(c => new CourseCard(
                    Category: c.CategoryName,
                    Title: c.Name,
                    Price: $"IDR {c.Price:N0}",
                    Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-course.svg" : c.ImageUrl,
                    Id: c.Id
                ));

                CurrentPage = response.PageNumber;
                TotalPages = response.TotalPages;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading paginated courses: {ex.Message}");
        }
    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
            await LoadCoursesAsync(page);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCoursesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return; //Jangan update lagi setelah render pertama
        }
        await LoadHome();
        StateHasChanged(); // Panggil function ini untuk mengupdate tampilan dengan data baru
    }

    private async Task LoadHome()
    {
        try
        {
            // Ambil courses
            var result = await CourseService.GetAllCourseAsync();
            if (result != null)
            {
                FeaturedCourses = result
                    .Where(c => c.IsActive)
                    .Select(c => new CourseCard(
                        Category: c.CategoryName,
                        Title: c.Name,
                        Price: $"IDR {c.Price:N0}",
                        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-course.svg" : c.ImageUrl,
                        Id: c.Id
                    ));
            }
            // Ambil categories
            var result2 = await CourseService.GetAllCategoriesAsync();
            if (result2 != null)
            {
                Categories = result2
                    .Where(c => c.IsActive)
                    .Select(c => new CategoryItem(
                        Name: c.Name,
                        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-category.svg" : c.ImageUrl,
                        Id: c.Id
                    ));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }
} *@