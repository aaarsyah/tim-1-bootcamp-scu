@page "/"

@using System.Globalization
@using MudBlazor
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation

@inject ICourseService CourseService

<PageTitle>Home Apple Music</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0 ma-0" Style="position: relative; object-fit: cover;">
    <!-- Banner -->
    <div class="pa-0 ma-n4">
        <MudImage Class="object-cover" Src="img/LandingBanner.svg" Alt="Landing Page Banner"
                Style="display: block; width: 100%; object-fit: cover;" />
    </div>

    <!-- Overlay Content -->
    <MudContainer Class="overlay-text"
                  Style="position: absolute; 
                         overflow: scroll; 
                         inset: 0;
                         width: 100%;
                         place-items: center;
                         color: white;">
        <MudStack Spacing="2" Align="Center">                 
            <MudText Class="mt-20 ma-4" Typo="Typo.h1" Align="Align.Center">
                Hi Musiker! Gabung yuk di Apel Music
            </MudText>
            <MudText Class="ma-4 mb-6" Typo="Typo.h2" Align="Align.Center" Style="font-weight: 400">
                Banyak kelas keren yang bisa menunjang bakat bermusik kamu
            </MudText>
        </MudStack>

        <!-- Statistik -->
        <MudGrid Class="my-4 d-flex justify-space-evenly">
            <MudItem xs="12" sm="6" md="4" >
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h1" Color="Color.Primary" Align="Align.Center" Style="font-size: 48px">
                        500+
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4" Align="Align.Center">
                        Lebih dari sekedar kelas biasa yang bisa mengeluarkan bakat kalian
                    </MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h1" Color="Color.Primary" Align="Align.Center" Style="font-size: 48px">
                        50+
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4" Align="Align.Center">
                        Lulusan yang menjadi musisi ternama dengan skill memukau
                    </MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 py-10 rounded-xl">
                    <MudText Typo="Typo.h1" Color="Color.Primary" Align="Align.Center" Style="font-size: 48px">
                        10+
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4" Align="Align.Center">
                        Coach Special kolaborasi dengan 
                        <br /> musisi terkenal
                    </MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudContainer>

<!-- ====== Explore Kelas Favorit ====== -->
<MudContainer MaxWidth="MaxWidth.Large" Class="py-5">
    <MudStack Spacing="4">
        <MudText Class="mt-16" Typo="Typo.h2" Align="Align.Center" Style="font-family: Inter" Color="Color.Primary">
            Explore kelas favorit
        </MudText>

        <MudGrid Class="mb-20 mt-4 gap-10 d-flex justify-space-evenly">
            @if (FeaturedCourses is null)
            {
                //Jika null maka akan menampilkan loading indicator
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                @foreach (var course in FeaturedCourses)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Class="course-card" Elevation="0">
                            <MudLink OnClick="@(() => Navigation.GoToDetail(course.Id.Value))" Color="Color.Default">
                                <MudImage Src="@course.Image"
                                        Class="w-100 mb-2"
                                        Alt="@course.Title" />
                                <MudText Typo="Typo.h4" Style="font-weight: 400; color: #828282">@course.Category</MudText>
                                <MudText Typo="Typo.h3">@course.Title</MudText>
                                <MudText Class="pt-10" Typo="Typo.h3" Color="Color.Primary">
                                    @course.Price
                                </MudText>
                            </MudLink>
                        </MudPaper>
                    </MudItem>
                }
            }
        </MudGrid>

            <!-- Pagination Button -->
            @if (CurrentPage < TotalPages)
            {
                <MudGrid Justify="Justify.Center" Class="mb-5">
                    <MudButton Variant="Variant.Filled"
                            Color="Color.Primary"
                            Disabled="@isLoadingMore"
                            OnClick="LoadMoreAsync">
                        @(isLoadingMore ? "Loading..." : "Load More")
                    </MudButton>
                </MudGrid>
            }
    </MudStack>
</MudContainer>


<!-- ====== Pilih Kelas Impian Kamu ====== -->
<div class="pa-0 ma-n4">
    <MudContainer MaxWidth="MaxWidth.False" Style="background-color: rgb(165 166 246 / 20%);" Class="category-section py-8" DisableGutters="true">
        <MudStack Spacing="2">
            <MudText Class="mt-16" Typo="Typo.h2" Align="Align.Center" Style="font-family: Inter" Color="Color.Primary">
                Pilih kelas impian kamu
            </MudText>
            <MudGrid Spacing="3" Class="mt-4 mb-20">
                @if (Categories is null)
                {
                    //Jika null maka akan menampilkan loading indicator
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                }
                else
                {
                    @foreach (var category in Categories)
                    {
                        <MudItem xs="3" sm="3" md="3" lg="3" Class="d-flex justify-space-evenly">
                            <MudLink OnClick="@(() => Navigation.GoToListMenu(category.Id.Value))" Color="Color.Default">
                                <MudImage Class="w-100 mb-2"
                                          Src="@category.Image"
                                          Alt="@category.Name" />
                                <MudText Class="ma-4 mb-6" Typo="Typo.h2" Align="Align.Center" Style="font-weight: 400">@category.Name</MudText>
                            </MudLink>    
                        </MudItem>
                    }
                }
            </MudGrid>
        </MudStack>
    </MudContainer>
</div>

<!-- Benefit -->
 <MudContainer MaxWidth="MaxWidth.Large" Class="py-16">
            <MudGrid AlignItems="Center">
                <MudItem xs="12" md="5">
                    <div class="benefit-illustration">
                        <MudImage Src="img/LandingBenefit.svg"
                                  Alt="Guitar Player Illustration"/>
                    </div>
                </MudItem>
                <MudItem xs="12" md="7">
                    <MudStack Spacing="2">
                        <MudText Class="mt-16" Typo="Typo.h2" Color="Color.Primary">
                            Benefit ikut Apel Course
                        </MudText>
                        <br/>
                        <MudText>
                            Dengan mengikuti AppleMusic Course, peserta akan mendapatkan berbagai keuntungan, antara lain:  
                            <ul>
                                <li>Akses ke materi musik interaktif dari instruktur profesional.</li>
                                <li>Belajar berbagai instrumen dan teknik vokal secara fleksibel kapan saja dan di mana saja.</li>
                                <li>Peningkatan kemampuan musik secara bertahap dengan modul terstruktur dan latihan praktik.</li>
                                <li>Kesempatan mengikuti workshop, performance online, dan mendapatkan sertifikat resmi.</li>
                                <li>Komunitas belajar yang mendukung, tempat berdiskusi dan berbagi pengalaman musik.</li>
                            </ul>
                        </MudText>
                        </MudStack>
                </MudItem>
            </MudGrid>
        </MudContainer>

@code {
    private record CourseCard(string Category, string Title, string Price, string Image, int? Id = null);
    private record CategoryItem(string Name, string Image, int? Id = null);

    private IEnumerable<CourseCard>? FeaturedCourses;
    private IEnumerable<CategoryItem>? Categories;
    private int CurrentPage = 1;
    private int ItemsPerPage = 6;
    private int TotalPages = 1;
    private bool isLoadingMore = false;

    // Load pertama kali
    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
        await LoadCoursesAsync();
    }

    // Load courses per halaman
    private async Task LoadCoursesAsync(int page = 1)
    {
        try
        {
            // Ambil courses
            var result = await CourseService.GetAllCoursePaginatedAsync(page, ItemsPerPage);
            if (result != null)
            {
                var courseCards = result.Data.Where(c => c.IsActive).Select(MapCourse);
                if (page == 1)
                {
                    FeaturedCourses = courseCards;
                }
                else
                {
                    FeaturedCourses = (FeaturedCourses ?? Enumerable.Empty<CourseCard>())
                        .Concat(courseCards)
                        .ToList();
                }
                CurrentPage = result.PageNumber;
                TotalPages = result.TotalPages;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading paginated courses: {ex.Message}");
        }

    }

    // Tombol Load More
    private async Task LoadMoreAsync()
    {
        if (CurrentPage < TotalPages && !isLoadingMore)
        {
            isLoadingMore = true;
            await LoadCoursesAsync(CurrentPage + 1);
            isLoadingMore = false;
            StateHasChanged();
        }
    }

    // Load Categories
    private async Task LoadCategoriesAsync()
    {
        try
        {
            // Ambil categories
            var result = await CourseService.GetAllCategoriesAsync();
            if (result != null)
            {
                Categories = result
                    .Where(c => c.IsActive)
                    .Select(c => new CategoryItem(
                        Name: c.Name,
                        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-category.svg" : c.ImageUrl,
                        Id: c.Id
                    ));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    // Mapper helper
    private CourseCard MapCourse(CourseDto c) => new(
        Category: c.CategoryName,
        Title: c.Name,
        Price: $"IDR {c.Price.ToString("N0", new CultureInfo("id-ID"))}",
        Image: string.IsNullOrEmpty(c.ImageUrl) ? "img/default-course.svg" : c.ImageUrl,
        Id: c.Id
    );
}
