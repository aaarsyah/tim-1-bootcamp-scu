@page "/checkout"

@using System.Globalization
@using System.Net.Http.Json
@using MyApp.Shared.DTOs

@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject HttpClient Http

<PageTitle>Checkout</PageTitle>

<MudDialogProvider />

<MudContainer Class="pa-4">

    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudCheckBox T="bool?" 
             Value="selectAllCheckbox" 
             ValueChanged="OnSelectAllChanged" 
             Size="Size.Small" 
             Color="Color.Primary" />
        <MudText>Pilih Semua</MudText>
    </MudStack>

    <MudDivider Class="my-2" />

    @if (_itemList.Count == 0)
    {
        <MudText Align="Align.Center" Color="Color.Secondary">Tidak ada item di keranjang Anda.</MudText>
    }
    else
    {
        @foreach (var item in _itemList)
        {
            <MudStack Class="ma-4" Row="true" AlignItems="AlignItems.Center">
                <MudCheckBox @bind-Value="item.Selected" Size="Size.Small" Color="Color.Primary" />
                @* Src="@item.Image" *@
                <MudImage Style="width:100px; height:100px; object-fit:contain;" /> 
                <MudContainer>
                    <MudText Style="color: #828282">
                    @* @item.Category *@
                    </MudText>
                    <MudText Style="color: #333333"><b>@item.Name</b></MudText>
                    <MudText Style="color: #4F4F4F">
                        Jadwal :
                        @* Jadwal : @item.StartDate.ToString("D", new CultureInfo("id-ID")) *@
                    </MudText>
                    <MudText Color="Color.Primary">
                        <b>IDR 
                        @* @item.Price.ToString("N0", new CultureInfo("id-ID")) *@
                        </b>
                    </MudText>
                </MudContainer>
                <MudSpacer />
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error"
                           OnClick="() => RemoveItem(item)">
                    Hapus
                </MudButton>
            </MudStack>
            <MudDivider />
        }
    }

    <MudToolBar Class="mt-4">
        <MudText>Total biaya:</MudText>
        <MudText Color="Color.Primary">
            <b>IDR @_itemList.Where(x => x.Selected).Sum(x => x.Price)
                .ToString("N0", new CultureInfo("id-ID"))</b>
        </MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnButtonClickedAsync">
            <MudText>Bayar Sekarang</MudText>
        </MudButton>
    </MudToolBar>

</MudContainer>

<MudMessageBox @ref="_mudMessageBox" Title="Pilih Metode Pembayaran">
    <MessageContent>
        <MudStack>
            @if (payments.Count == 0)
            {
                <MudText>Memuat metode pembayaran...</MudText>
            }
            else
            {
                @foreach (var payment in payments)
                {
                    <MudButton 
                        Variant="@GetVariant(payment.Name)"
                        Color="@GetColor(payment.Name)"
                        OnClick="@(() => SelectPayment(payment))"
                        Style="justify-content:flex-start; width:100%; text-transform:none; margin:8px 0; border-radius:10px;">
                        
                        <MudImage Src="@payment.LogoUrl" Style="width:40px; margin-right:8px;" />
                        <MudText>@payment.Name</MudText>
                    </MudButton>
                }
            }
        </MudStack>
    </MessageContent>
    
    <NoButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;">Batal</MudButton>
    </NoButton>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;" OnClick="OnPaymentConfirmed">Bayar</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    private MudMessageBox _mudMessageBox;
    private bool? selectAllCheckbox = false;
    private string? selectedPayment;
    private int? selectedPaymentId;
    private int _totalPrice = 0;

    private List<ItemMy> _itemList = new();
    private List<PaymentDto> payments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCartItemsAsync();
        await LoadPaymentsAsync();
    }

    private async Task LoadCartItemsAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<CartItemResponseDto>>>("api/CartItem/cart");

            if (response?.Data != null)
            {
                _itemList = response.Data.Select(c => new ItemMy(
                    c.Id,
                    @* c.ImageUrl,
                    c.CategoryName, *@
                    @* (int)c.Price, *@
                    @* DateOnly.FromDateTime(c.ScheduleDate.ToDateTime(TimeOnly.MinValue), *@
                    c.CourseName
                )).ToList();

                UpdatePrice(); //tambahkan price di DTO
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat keranjang: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadPaymentsAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<PaymentDto>>>("api/payment");
            if (response?.Data != null)
            {
                payments = response.Data.Where(p => p.IsActive).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat metode pembayaran: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnButtonClickedAsync()
    {
        if (!_itemList.Any(i => i.Selected))
        {
            Snackbar.Add("Pilih minimal satu item untuk checkout!", Severity.Warning);
            return;
        }

        await _mudMessageBox.ShowAsync();
    }

    private void SelectPayment(PaymentDto payment)
    {
        selectedPayment = payment.Name;
        selectedPaymentId = payment.Id;
        StateHasChanged();
    }

    private Color GetColor(string name) => name == selectedPayment ? Color.Primary : Color.Default;
    private Variant GetVariant(string name) => name == selectedPayment ? Variant.Outlined : Variant.Text;

    private async Task OnPaymentConfirmed()
    {
        if (selectedPaymentId == null)
        {
            Snackbar.Add("Silakan pilih metode pembayaran dulu!", Severity.Warning);
            return;
        }

        var selectedCartIds = _itemList
            .Where(x => x.Selected)
            .Select(x => x.Id)
            .ToList();

        var checkoutRequest = new CheckoutRequestDto
        {
            ItemCartIds = selectedCartIds,
            PaymentMethodId = selectedPaymentId.Value
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/CartItem/checkout", checkoutRequest);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Checkout berhasil! Mengarahkan ke halaman pembayaran...", Severity.Success);
                Navigation.NavigateTo("/payment-success");
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Checkout gagal: {content}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Terjadi kesalahan: {ex.Message}", Severity.Error);
        }
    }

    // âœ… Toggle Select All dan update harga total
    private async Task OnSelectAllChanged(bool? value)
    {
        selectAllCheckbox = value;

        foreach (var item in _itemList)
        {
            item.Selected = value == true;
        }

        //tambahkan Price di DTO
        UpdatePrice();
        StateHasChanged();
    }

    //Hitung total harga item yang dipilih
    public void UpdatePrice()
    {
        _totalPrice = _itemList
            .Where(i => i.Selected)
            .Sum(i => i.Price);
    }


    // belum konek API Controller remove bukan dari cartId melainkan scheduleId

    public async Task RemoveItem(ItemMy item)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/CartItem/remove?cartid={item.Id}");

            if (response.IsSuccessStatusCode)
            {
                _itemList.Remove(item);
                Snackbar.Add($"Item '{item.Name}' berhasil dihapus dari keranjang.", Severity.Success);
                UpdatePrice();
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Gagal menghapus item: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Terjadi kesalahan saat menghapus item: {ex.Message}", Severity.Error);
        }
    }

    public class ItemMy
    {
        public int Id { get; set; }
        public bool Selected { get; set; }
        @* public string Image { get; set; }
        public string Category { get; set; } *@
        public string Name { get; set; }
        public int Price { get; set; }
        @* public DateOnly StartDate { get; set; } *@

        public ItemMy(int id, string name)
        {
            Id = id;
            @* Image = image;
            Category = category; *@
            Name = name;
            @* Price = price;
            StartDate = startDate; *@
        }
    }
}


@* @page "/checkout"

@using System.Globalization
@using MyApp.Shared.DTOs
@inject HttpClient _httpClient

@using System.Globalization

@inject NavigationManagerExt Navigation;
@inject ISnackbar Snackbar

<PageTitle>Checkout</PageTitle>

<MudDialogProvider
    FullWidth="false"
    MaxWidth="MaxWidth.ExtraSmall"
    CloseButton="false"
    BackdropClick="true"
    NoHeader="false"
    Position="DialogPosition.Center"
    CloseOnEscapeKey="true"
    BackgroundClass=""/>

<MudContainer>
    <MudStack Row="true" AlignItems="AlignItems.Center">
        
        <MudCheckBox T="bool?" 
             Value="selectallcheckbox" 
             ValueChanged="OnSelectAllChanged" 
             Size="Size.Small" 
             Color="Color.Primary" />

        <MudText>Pilih Semua</MudText>
    </MudStack>
    <MudDivider></MudDivider>
    @foreach (ItemMy item in _itemList)
    {
        <MudStack Class="ma-4"  Row="true" AlignItems="AlignItems.Center">
            <MudCheckBox @bind-Value="item.Selected" Size="Size.Small" Color="Color.Primary"
                         Checked="(e => UpdatePrice())"></MudCheckBox>
            <MudImage Src=@item.Image></MudImage>
            <MudContainer>
                <MudText Style="color: #828282">@item.Category</MudText>
                <MudText Style="color: #333333"><b>@item.Name</b></MudText>
                <MudText Style="color: #4F4F4F">Jadwal : @item.StartDate.ToString("D", new CultureInfo("id-ID"))</MudText>
                <MudText Color="Color.Primary">
                    <b>IDR @item.Price.ToString("N0", new CultureInfo("id-ID"))</b>
                </MudText>
            </MudContainer>
            <MudSpacer />
            <MudButton Class="pa-4" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error"
                        OnClick="(e => RemoveItem(item))">
                <MudText>Delete</MudText>
            </MudButton>
        </MudStack>
        <MudDivider></MudDivider>
    }

    <MudDivider></MudDivider>
    <MudToolBar>
        <MudText>
            Total biaya:
        </MudText>
        <MudText Color="Color.Primary">
            <b>IDR @_itemList.Where(x => x.Selected).Aggregate(0, (total, x) => total + x.Price).ToString("N0", new CultureInfo("id-ID"))</b>
        </MudText>
        <MudSpacer></MudSpacer>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnButtonClickedAsync">
            <MudText>Bayar Sekarang</MudText>
        </MudButton>
    </MudToolBar>

</MudContainer>

<MudMessageBox @ref="_mudMessageBox" Title="Pilih Metode Pembayaran">
    <MessageContent>
    <MudStack>
        @foreach (var payment in payments)
        {
            <MudButton 
                Variant="@GetVariant(payment.Name)"
                Color="@GetColor(payment.Name)"
                OnClick="@(() => SelectPayment(payment.Name))"
                Style="justify-content:flex-start; width:100%; text-transform:none; margin:8px 0; border-radius:10px;">
                
                <MudImage Src="@payment.Image" Style="width:40px; margin-right:8px;" />
                <MudText>@payment.Name</MudText>
            </MudButton>
        }
        </MudStack>
    </MessageContent>
    
    
    <NoButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;" OnClick="Navigation.GoToCheckout">Batal</MudButton>
    </NoButton>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mx-auto mb-2" Style="width: 170px;" OnClick="OnPaymentConfirmed">Bayar</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    private string? selectedPayment;

    private List<(string Name, string Image)> payments = new()
    {
        ("GoPay", "img/Payment1.svg"),
        ("OVO", "img/Payment2.svg"),
        ("DANA", "img/Payment3.svg"),
        ("Mandiri", "img/Payment4.svg"),
        ("BCA", "img/Payment5.svg"),
        ("BNI", "img/Payment6.svg")
    };

    private void SelectPayment(string name)
    {
        selectedPayment = name;
        StateHasChanged();
    }

//Perubahan warna ketika di Select Payment nya masih belum aktif 
    private Color GetColor(string name)
    {
        return name == selectedPayment ? Color.Primary : Color.Default;
    }

    private Variant GetVariant(string name)
    {
        return name == selectedPayment ? Variant.Outlined : Variant.Text;
    }

    //Gunanya untuk post nanti ke invoice
    private void OnPaymentConfirmed()
    {
        if (string.IsNullOrEmpty(selectedPayment))
        {
            // Kalau belum pilih metode pembayaran
            Snackbar.Add("Silakan pilih metode pembayaran dulu!", Severity.Warning);
            return;
        }

        // Navigasi ke halaman berikut dengan membawa parameter
        Navigation.GoToPaymentMethodSelected(selectedPayment);
    }

    public class ItemMy
    {
        public bool Selected { get; set; }
        public String Image { get; set; }
        public String Category { get; set; }
        public String Name { get; set; }
        public int Price { get; set; }
        public DateOnly StartDate { get; set; }
        public ItemMy(String Image, String Category, String ShortDesc, int Price, DateOnly StartDate)
        {
            this.Selected = false;
            this.Image = Image;
            this.Category = Category;
            this.Name = ShortDesc;
            this.Price = Price;
            this.StartDate = StartDate;
        }
    }
    private bool? selectallcheckbox = false;


    private HashSet<ItemMy> selectedItems = new HashSet<ItemMy>();
    private MudMessageBox _mudMessageBox;
    private List<ItemMy> _itemList = new List<ItemMy>();

    private int _totalPrice = 0;

    protected override void OnInitialized()
    {
        _itemList.Add(new ItemMy(
            "img/Checkout1.svg",
            "Drum",
            "Kursus Drummer Special Coach (Eno Netral)",
            6500000,
            new DateOnly(2022, 10, 25)
        ));
        _itemList.Add(new ItemMy(
            "img/Checkout2.svg",
            "Biola",
            "Biola Mid-Level Course",
            3000000,
            new DateOnly(2022, 10, 23)
        ));
        _itemList.Add(new ItemMy(
            "img/Checkout3.svg",
            "Drum",
            "Expert Level Drummer Lessons",
            5450000,
            new DateOnly(2022, 10, 25)
        ));
        _itemList.Add(new ItemMy(
            "img/Checkout4.svg",
            "Saxophone",
            "Expert Level Saxophone",
            7350000,
            new DateOnly(2022, 10, 27)
        ));
    }

    private async Task OnButtonClickedAsync()
    {
        bool? result = await _mudMessageBox.ShowAsync();
    }

    public void UpdatePrice()
    {
        _totalPrice = 0;
        foreach (ItemMy item in _itemList)
        {
            if (item.Selected)
            {
                _totalPrice += item.Price;
            }
        }
    }

    private async Task OnSelectAllChanged(bool? value)
    {
        selectallcheckbox = value;

        if (selectallcheckbox == true)
        {
            foreach (var item in _itemList)
            {
                item.Selected = true;
            }
        }
        else
        {
            foreach (var item in _itemList)
            {
                item.Selected = false;
            }
        }

        UpdatePrice();
    }


    public void RemoveItem(ItemMy item)
    {
        _itemList.Remove(item);
    }

} *@