@page "/checkout"

@using System.Globalization
@using System.Net.Http.Json
@using MyApp.Shared.DTOs
@using MyApp.BlazorUI.Services
@using System.Net.Http.Headers

@inject NavigationManagerExt Navigation
@inject ISnackbar Snackbar

@inject IAuthService AuthService
@inject ICheckoutService CheckoutService

@inject IDialogService DialogService

<PageTitle>Checkout</PageTitle>

<MudContainer Class="pa-4">
    <MudStack Class="mx-4" Row="true" AlignItems="AlignItems.Center">
        <MudCheckBox T="bool?" 
             Value="selectAllCheckbox" 
             ValueChanged="OnSelectAllChanged" 
             Size="Size.Small" 
             Color="Color.Primary" />
        <MudText Typo="Typo.h3" Style="font-weight: 400; font-size: 20px">Pilih Semua</MudText>
    </MudStack>

    <MudDivider Class="my-2" />

    @if (_itemList.Count == 0)
    {
        <MudText Align="Align.Center" Color="Color.Secondary">Tidak ada item di keranjang Anda.</MudText>
    }
    else
    {
        @foreach (var item in _itemList)
        {
            <MudStack Class="ma-4" Row="true" AlignItems="AlignItems.Center">
                <MudCheckBox @bind-Value="item.Selected" Size="Size.Small" Color="Color.Primary" />
                <MudImage Src="@item.Image" Style="width:100px; height:100px; object-fit:contain;" /> 
                <MudContainer>
                    <MudText Typo="Typo.h4" Style="font-weight: 400; color: #828282">@item.Category</MudText>
                    <MudText Typo="Typo.h2">@item.Name</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 400; color: #4F4F4F">
                        Jadwal : @item.ScheduleDates.ToString("D", new CultureInfo("id-ID"))
                    </MudText>
                    <MudText Typo="Typo.h3" Color="Color.Primary" Style="font-size: 20px">
                        IDR @item.Price.ToString("N0", new CultureInfo("id-ID"))
                    </MudText>
                </MudContainer>
                <MudSpacer />
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error"
                           OnClick="() => RemoveItem(item)">
                    Hapus
                </MudButton>
            </MudStack>
            <MudDivider />
        }
    }
    <MudToolBar Class="mt-4">
        <MudText Class="mr-6" Typo="Typo.h3" Style="font-weight: 400">Total biaya</MudText>
        <MudText Typo="Typo.h2" Color="Color.Primary">
            IDR @_itemList.Where(x => x.Selected).Sum(x => x.Price).ToString("N0", new CultureInfo("id-ID"))
        </MudText>
        <MudSpacer />
        <MudButton Class="px-10 py-2" Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowPaymentDialog">
            <MudText>Bayar Sekarang</MudText>
        </MudButton>
    </MudToolBar>

</MudContainer>

@code {
    private bool? selectAllCheckbox = false;
    private int _totalPrice = 0;

    private List<ItemMy> _itemList = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }
        var auth = await AuthService.GetAuthAsync();
        if (auth == null)
        {
            Navigation.GoToLogin(); // User belum login, arahkan user ke login page
            return;
        }
        await LoadCartItemsAsync(auth);
        StateHasChanged();
    }

    private async Task LoadCartItemsAsync(AuthenticationHeaderValue authentication)
    {
        try
        {
            var result = await CheckoutService.GetSelfCartItem(authentication);
            if (result != null)
            {
                _itemList = result.Select(c => new ItemMy(
                    c.Id,
                    c.ImageUrl,
                    c.CategoryName,
                    c.CourseName,
                    (int)c.Price,
                    c.Date
                )).ToList();

                UpdatePrice(); //tambahkan price di DTO
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Gagal memuat keranjang: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowPaymentDialog()
    {
        if (!_itemList.Any(i => i.Selected))
        {
            Snackbar.Add("Pilih minimal satu item untuk checkout!", Severity.Warning);
            return;
        }

        var selectedCartIds = _itemList
            .Where(x => x.Selected)
            .Select(x => x.Id)
            .ToList();

        var checkoutRequest = new CheckoutRequestDto
            {
                ItemCartIds = selectedCartIds,
                PaymentMethodId = null
            };

        var parameters = new DialogParameters();
        parameters.Add("CheckoutRequest", checkoutRequest);


        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CheckoutDialog>("Pilih Metode Pembayaran", parameters, options);
        var result = await dialog.Result;

        // if (true)
        // {
        //     var auth = await AuthService.GetAccessTokenAsync();
        //     if (auth == null)
        //     {
        //         Navigation.GoToLogin(); // User belum login, arahkan user ke login page
        //         return;
        //     }
        // }

        // await _mudMessageBox.ShowAsync();
    }

    // Toggle Select All dan update harga total
    private void OnSelectAllChanged(bool? value)
    {
        selectAllCheckbox = value;

        foreach (var item in _itemList)
        {
            item.Selected = value == true;
        }

        //tambahkan Price di DTO
        UpdatePrice();
        StateHasChanged();
    }

    //Hitung total harga item yang dipilih
    public void UpdatePrice()
    {
        _totalPrice = _itemList
            .Where(i => i.Selected)
            .Sum(i => i.Price);
    }


    // belum konek API Controller remove bukan dari cartId melainkan scheduleId

    public async Task RemoveItem(ItemMy item)
    {
        // Dapatkan autentikasi
        var auth = await AuthService.GetAuthAsync();
        if (auth == null)
        {
            Navigation.GoToLogin(); // User belum login, arahkan user ke login page
            return;
        }
        try
        {
            var result = await CheckoutService.RemoveCourseFromCart(auth, item.Id);
            if (!result)
            {
                Snackbar.Add($"Gagal menghapus item", Severity.Error);
                return;
            }
            _itemList.Remove(item);
            Snackbar.Add($"Item '{item.Name}' berhasil dihapus dari keranjang.", Severity.Success);
            UpdatePrice();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Terjadi kesalahan saat menghapus item: {ex.Message}", Severity.Error);
        }
    }

    public class ItemMy
    {
        public int Id { get; set; }
        public bool Selected { get; set; }
        public string Image { get; set; }
        public string Category { get; set; }
        public string Name { get; set; }
        public int Price { get; set; }
        public DateOnly ScheduleDates { get; set; }

        public ItemMy(int id, string image, string category, string name, int price, DateOnly scheduleDates)
        {
            Id = id;
            Image = image;
            Category = category;
            Name = name;
            Price = price;
            ScheduleDates = scheduleDates;
        }
    }
}