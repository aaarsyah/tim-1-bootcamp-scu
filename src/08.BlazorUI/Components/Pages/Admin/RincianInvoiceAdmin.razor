@page "/details-invoice-admin/{InvoiceRefIdS}"
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs
@using System.Globalization

@inject NavigationManagerExt Navigation

@inject IAuthService AuthService
@inject ICheckoutService CheckoutService

<PageTitle>Rincian Invoice</PageTitle>

<style>
/* Selang-seling warna baris */
.mud-table tr:nth-child(even) {
    background-color: rgba(184, 134, 11, 0.2) !important; /* Kuning tua transparan */
}
</style>

<MudContainer class="mt-20">
    @if (isLoading)
    {
        <div class="d-flex justify-center mt-10">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
        </div>
    }
    else if (invoiceDetails == null || !invoiceDetails.Any())
    {
        <MudText Class="mt-6" Typo="Typo.subtitle1" Align="Align.Center">
            Tidak ada data rincian invoice.
        </MudText>
    }
    else
    {
        <MudText Typo="Typo.subtitle1" Class="mt-6 mb-4 fw-bold"><b> Rincian Invoice</b></MudText>
        <MudItem xs="16" sm="8">
            <MudText Typo="Typo.subtitle1" Class="mb-2"><b>No.Invoice: @Invoice.RefCode</b></MudText>
            <MudText Typo="Typo.subtitle1" Class="mb-2"><b>Tanggal Beli: @Invoice.CreatedAt.ToString("d MMMM yyyy", new CultureInfo("id-ID"))</b></MudText>
        </MudItem>

        <MudItem Class="d-flex justify-end">
            <MudText Typo="Typo.subtitle1" Class="mb-4 fw-bold"><b>Total Harga: @($"IDR {Invoice.TotalPrice:N0}")</b></MudText>
        </MudItem>

        <MudTable T="InvoiceDetailDto" Items="@invoiceDetails" Hover="true" Breakpoint="Breakpoint.Sm"
                  Class="mt-4"
                  @ref="mudTable"
                  RowClass="cursor-pointer"
                  RowClassFunc="@SelectedRowClassFunc"
                  OnRowClick="RowClickEvent">

            <HeaderContent>
                <MudTh Style="background-color: #F8D24B; color: black;">No.</MudTh>
                <MudTh Style="background-color: #F8D24B; color: black;">Nama Course</MudTh>
                <MudTh Style="background-color: #F8D24B; color: black;">Kategori</MudTh>
                <MudTh Style="background-color: #F8D24B; color: black;">Jadwal</MudTh>
                <MudTh Style="background-color: #F8D24B; color: black;">Harga</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="No.">@(invoiceDetails.IndexOf(context) + 1)</MudTd>
                <MudTd DataLabel="NamaCourse">@context.CourseName</MudTd>
                <MudTd DataLabel="Kategori">@context.CategoryName</MudTd>
                <MudTd DataLabel="JadwalKursus">@context.ScheduleDate.ToString("d MMMM yyyy", new CultureInfo("id-ID"))</MudTd>
                <MudTd DataLabel="Harga">@($"IDR {context.Price:N0}")</MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    [Parameter]
    public string InvoiceRefIdS { get; set; } = string.Empty;

    private Guid InvoiceRefId { get; set; }

    private bool isLoading = true;
    private MudTable<InvoiceDetailDto> mudTable = null!;
    private int selectedRowNumber = -1;
    private List<InvoiceDetailDto> invoiceDetails = new();
    private InvoiceDto Invoice = new();

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(InvoiceRefIdS) || !Guid.TryParse(InvoiceRefIdS, out Guid guid))
        {
            // Invalid Guid, redirect to home
            Navigation.GoToHome();
            return;
        }
        InvoiceRefId = guid;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }
        var auth = await AuthService.GetAuthAsync();
        if (auth == null)
        {
            Navigation.GoToLogin(); // User belum login, arahkan user ke login page
            return;
        }
        var invoice = await CheckoutService.GetInvoiceByIdAdminAsync(auth, InvoiceRefId);
        if (invoice == null)
        {
            // Tidak ada invoice, kosong
            isLoading = false;
            StateHasChanged();
            return;
        }
        Invoice = invoice;
        invoiceDetails = await CheckoutService.GetInvoiceDetailsByInvoiceIdAdminAsync(auth, InvoiceRefId); // TODO: .OrderByDescending(i => i.CreatedAt).ToList()
        isLoading = false;
        StateHasChanged();
    }

    private void RowClickEvent(TableRowClickEventArgs<InvoiceDetailDto> args)
    {
        Console.WriteLine($"Row clicked: {args.Item?.CourseName}");
    }

    private string SelectedRowClassFunc(InvoiceDetailDto element, int rowNumber)
    {
        if (selectedRowNumber == rowNumber)
        {
            selectedRowNumber = -1;
            return string.Empty;
        }
        else if (mudTable.SelectedItem != null && mudTable.SelectedItem.Equals(element))
        {
            selectedRowNumber = rowNumber;
            return "selected";
        }
        else
        {
            return string.Empty;
        }
    }
}
