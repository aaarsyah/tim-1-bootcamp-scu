@page "/reset-password"
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using MyApp.BlazorUI.Services
@using MyApp.Shared.DTOs

@inject NavigationManagerExt Navigation
@inject ISnackbar Snackbar

@inject IAuthService AuthService

<PageTitle>Reset Password</PageTitle>
<MudPaper Class="pa-0 mx-auto mt-12" MaxWidth="800px" Elevation="0">
    <MudForm @ref="_form">
        <MudText Class="mb-4" Typo="Typo.h2" Style="font-weight: 400">Buat Password</MudText>
        <MudTextField T="string" 
                        Label="Password Baru"
                        Variant="Variant.Outlined"
                        @bind-Value="_resetPasswordModel.NewPassword"
                        @ref="pwField1"
                        InputType="@_newPasswordInputType"
                        Required="true"
                        RequiredError="Password Harus Diisi!"
                        MaxLength="72"
                        Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))"
                        Adornment="Adornment.End"
                        AdornmentIcon="@_newPasswordIcon"
                        OnAdornmentClick="ToggleNewPasswordVisibility"
                        HelperText="Min 8 characters, uppercase, lowercase, number, special char" />
        <MudTextField T="string"
                        Label="Konfirmasi Password Baru"
                        Variant="Variant.Outlined"
                        @bind-Value="_resetPasswordModel.ConfirmNewPassword"
                        InputType="@_confirmPasswordInputType"
                        Required="true"
                        RequiredError="Konfirmasi Password Harus Diisi!"
                        MaxLength="72"
                        Validation="@(new Func<string, string?>(PasswordMatch))"
                        Adornment="Adornment.End"
                        AdornmentIcon="@_confirmPasswordIcon"
                        OnAdornmentClick="ToggleConfirmPasswordVisibility"
                        HelperText="Repeat the password" />
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        
        <MudStack Direction="Row" Spacing="5" Row="true" class="mt-4">
            @* Tidak diperlukan, karena user yang mengklik link email sudah yakin akan mengganti password *@
            @* <MudButton OnClick="Navigation.GoToForgotPass" Variant="Variant.Outlined" Color="Color.Primary" Disabled="@_isLoading" Style="width: 140px; height: 43px; border-radius: 8px">
                <MudText Typo="Typo.h4" Style="font-weight: 500; font-size: 15px">Batal</MudText>
            </MudButton> *@

            @* Button Konfirmasi *@
            <MudButton OnClick="OnConfirm" Variant="Variant.Filled" Color="Color.Primary" Disabled="@_isLoading" Style="width: 140px; height: 43px; border-radius: 8px">
                <MudText Typo="Typo.h4" Style="font-weight: 500; font-size: 15px">Kirim</MudText>
            </MudButton>
        </MudStack>

    </MudForm>   
</MudPaper>


@code {
    [SupplyParameterFromQuery(Name = "email")]
    private string? Email { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    private string? Token { get; set; }

    MudTextField<string> pwField1;
    MudForm _form;

    private bool _isLoading = false;
    private InputType _newPasswordInputType = InputType.Password;
    private string _newPasswordIcon = Icons.Material.Filled.VisibilityOff;

    private InputType _confirmPasswordInputType = InputType.Password;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    private ResetPasswordRequestDto _resetPasswordModel = new();

    protected override void OnAfterRender(bool firstRender)
    {
        _resetPasswordModel.Email = Uri.UnescapeDataString(Email ?? string.Empty);
        _resetPasswordModel.PasswordResetToken = Uri.UnescapeDataString(Token ?? string.Empty);
        if (string.IsNullOrWhiteSpace(_resetPasswordModel.Email) || string.IsNullOrWhiteSpace(_resetPasswordModel.PasswordResetToken))
        {
            Snackbar.Add("Password reset token invalid.", Severity.Error);
            Navigation.GoToHome();
            return;
        }
    }

    private void ToggleNewPasswordVisibility()
    {
        if (_newPasswordInputType == InputType.Password)
        {
            _newPasswordInputType = InputType.Text;
            _newPasswordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _newPasswordInputType = InputType.Password;
            _newPasswordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private void ToggleConfirmPasswordVisibility()
    {
        if (_confirmPasswordInputType == InputType.Password)
        {
            _confirmPasswordInputType = InputType.Text;
            _confirmPasswordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _confirmPasswordInputType = InputType.Password;
            _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password Harus Diisi!";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Password must be at least of length 8";
        if (!Regex.IsMatch(pw, @"[A-Z]", RegexOptions.NonBacktracking))
            yield return "Password must contain at least one capital letter";
        if (!Regex.IsMatch(pw, @"[a-z]", RegexOptions.NonBacktracking))
            yield return "Password must contain at least one lowercase letter";
        if (!Regex.IsMatch(pw, @"\d", RegexOptions.NonBacktracking))
            yield return "Password must contain at least one digit number";
        if (!Regex.IsMatch(pw, @"[ -/:-@[-`{-~]", RegexOptions.NonBacktracking))
            yield return "Password must contain at least one special character";
    }

    private string? PasswordMatch(string arg)
    {
        if (pwField1.Value != arg)
            return "Password tidak sesuai";
        return null;
    }

    private async Task OnConfirm()
    {
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }
        _isLoading = true;

        // Email dan token sudah diset dari query parameters, tidak perlu set lagi

        try
        {
            var result = await AuthService.ResetPasswordAsync(_resetPasswordModel);
            _isLoading = false;
            if (result)
            {
                Snackbar.Add("Password successfully reset!", Severity.Success);
                Navigation.GoToHome();
            }
            else
            {
                Snackbar.Add("Failed to reset password. Password reset token may be invalid.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _isLoading = false;
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}